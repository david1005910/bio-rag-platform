name: CD

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  # Notify deployment start
  notify-start:
    name: Notify Deployment Start
    runs-on: ubuntu-latest
    steps:
      - name: Deployment Started
        run: |
          echo "üöÄ Deployment triggered for commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Author: ${{ github.actor }}"

  # Backend deployment via Render (auto-deployed on push)
  deploy-backend:
    name: Deploy Backend (Render)
    runs-on: ubuntu-latest
    needs: notify-start
    steps:
      - name: Trigger Render Deploy
        run: |
          echo "üì¶ Backend deployment triggered"
          echo "Render auto-deploys from GitHub push"
          echo "Service: bio-rag-platform-1.onrender.com"

      - name: Wait for Render deployment
        run: |
          echo "‚è≥ Waiting for Render deployment to complete..."
          sleep 60

      - name: Health Check
        run: |
          echo "üîç Checking backend health..."
          for i in {1..5}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://bio-rag-platform-1.onrender.com/health || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Backend is healthy!"
              exit 0
            fi
            echo "Attempt $i: Got $response, retrying in 30s..."
            sleep 30
          done
          echo "‚ö†Ô∏è Backend health check timed out (may still be deploying)"

  # Frontend deployment via Vercel (auto-deployed on push)
  deploy-frontend:
    name: Deploy Frontend (Vercel)
    runs-on: ubuntu-latest
    needs: notify-start
    steps:
      - name: Trigger Vercel Deploy
        run: |
          echo "üì¶ Frontend deployment triggered"
          echo "Vercel auto-deploys from GitHub push"
          echo "Service: bio-rag.vercel.app"

      - name: Wait for Vercel deployment
        run: |
          echo "‚è≥ Waiting for Vercel deployment to complete..."
          sleep 60

      - name: Health Check
        run: |
          echo "üîç Checking frontend health..."
          for i in {1..3}; do
            response=$(curl -s -o /dev/null -w "%{http_code}" https://bio-rag.vercel.app || echo "000")
            if [ "$response" = "200" ]; then
              echo "‚úÖ Frontend is healthy!"
              exit 0
            fi
            echo "Attempt $i: Got $response, retrying in 20s..."
            sleep 20
          done
          echo "‚ö†Ô∏è Frontend health check timed out (may still be deploying)"

  # Summary
  deployment-summary:
    name: Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-backend, deploy-frontend]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "üìä Deployment Summary"
          echo "===================="
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref_name }}"
          echo ""
          echo "üîó URLs:"
          echo "  Backend:  https://bio-rag-platform-1.onrender.com"
          echo "  Frontend: https://bio-rag.vercel.app"
          echo "  API Docs: https://bio-rag-platform-1.onrender.com/docs"
          echo ""
          echo "‚úÖ Deployment workflow completed!"
